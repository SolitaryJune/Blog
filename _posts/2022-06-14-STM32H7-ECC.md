---
layout:     post
title:      "STM32H7读Flash出错-ECC校验出错"
subtitle:   "STM32H743,Read,CRC"
date:       2022-06-14
update:     2022-06-14
author:     "elmagnifico"
header-img: "img/z7.jpg"
catalog:    true
tags:
    - STM32
    - Embedded
---

## Forward

之前使用的是不带ECC的Flash，升级到H7以后，发现了读取Flash卡死的情况，并且卡死地址非常随机



## 类似例子

> https://community.st.com/s/question/0D50X0000Bq9fV9SQI/hard-fault-when-reading-flash
>
> https://community.st.com/s/question/0D53W00000Jkw8ZSAR/stm32h7-flash-write-returns-ok-yet-hard-fault-during-readback
>
> https://community.st.com/s/question/0D53W00000DJj2tSAD/stm32h743-random-hard-fault-while-reading-flash



> https://community.st.com/s/question/0D53W00001OQ3kbSAD/reading-from-flash-causes-hardfault
>
> https://community.st.com/s/question/0D50X00009XkhJbSAJ/hard-fault-writing-flash

发现一个奇怪问题，H系列的比例怎么这么高，有鬼



## 常见原因分析

1. MPU保护，这个比较常见经常是读写了被保护的区域导致出错了
2. 中断冲突，其实不太可能，写Flash的时候就挂起了整个系统了，中断都不响应了
3. 多核冲突，具有多个核心的板子，可能会在读写的时候，另一个核心也在做相反或者类似的操作，会造成冲突
4. Cache，SCB Enable以后可能数据Cache或者指令Cache和DMA等一起使用造成了冲突
5. Flash延迟错误，这种配置Flash Delay不正确，现在基本不太可能，都是Cube直接生成了

平常基本就是这几种可能，不过在我这里都直接排除了，他们发生的条件都不存在。



发生问题的地方非常有特点，是在PVD的记录区域出现了Flash Read以后HardFault，PVD记录区域是当系统断电的时候自动向Flash写入一条记录。由于是断电时写入，所以有一些track的东西。

正常写入都会先解锁Flash，先读回来，存起来，擦除Flash，再写入，写完再上锁。但是断电的时候时间不够用，所以会直接写入，而不进行擦除操作，更不可能还做什么读回来存起来这种操作了。这种方式在F7及以下的各种芯片里都可以正常工作，而不会引起大问题。

H7这里就开始出问题了，大概率H7的Flash有什么不一样的设定。



## ECC

![image-20220614105107703](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/image-20220614105107703.png)

对比F7的，明显多了一条ECC，H7是40nm工艺，制成越小，不带ECC就无法保证可靠性。

目前能做到的是1bit纠正，2bit检测，每32字节，10bit记录值。

![image-20220614110113749](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/image-20220614110113749.png)



## 分析

由于缺少了Erase操作，这就导致PVD写入后，出现Flash写入了，但是ECC区域没有写入，当上电以后，自动会读取一遍PVD记录区域，这就造成读的时候发现ECC校验不正确，进而进入到HardFault

![image-20220614110926635](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/image-20220614110926635.png)

![image-20220614111717869](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/image-20220614111717869.png)



![image-20220614112013094](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/image-20220614112013094.png)

## 处理

![image-20220614112345152](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/image-20220614112345152.png)

如果出现了ECC错误，自动擦除对应的区块



## Summary

唔，FLASH里面还是有不少小细节的



## Quote

> https://blog.csdn.net/qq_37868856/article/details/120704379
>
> https://www.armbbs.cn/forum.php?mod=viewthread&tid=86777

