---
layout:     post
title:      "BNO085异常，无Reset返回"
subtitle:   "BNO080"
date:       2022-01-03
update:     2022-01-03
author:     "elmagnifico"
header-img: "img/welding2.jpg"
catalog:    true
tags:
    - Embedded
    - sensor
---

## Forward

这个是年前遇到的问题，一直没处理，现在记录一下。

之前BNO是别人负责的，一直好像都有点小问题，但是不影响使用，我也没注意。现在转到我手上以后，一看满是问题啊。



## 情况

之前的问题是，这个传感器是不是就没数据返回了，然后通过重启传感器以后，又恢复了。由于不是大问题，就一直这么凑活用着。

现在遇到的新问题是，这个传感器彻底没数据返回了，reset也没用。



#### 内存溢出

一上来就看到了接收buff不够，有一个276字节的包，每次上电的时候都会收到，而接收buff才128，铁溢出了。但是改了这个还是没解决问题。



#### 极简驱动

整个驱动就重启、检测了一下传感器信号、然后发了一条配置命令，就开始工作了。特别的简单。但是问题是开始前的这一部分流程中，收到了好多个不能解析的包，不知道是什么内容，然后解析也会没有对应的分支，但是最后总能收到正确数据，这也太神奇（不干人事）了吧。



重新读驱动手册，发现第一个包276应该是传感器上电以后发送的广播包，用来告知当前传感器状态、版本等等信息的，而这个包没有解析，行吧，反正也不重要，不解就不解吧。



但是收包的时候又发现，这里面收到了非常多的NACK，这就很奇怪了，后面反复测试几次以后，直接芯片就彻底没反应了，通信完全失败了。只好等其他出问题的芯片拿回来继续了。



## Debug

#### 中断处理

平常芯片可能会给你一个中断引脚，告诉你这个是data ready或者类似的作用，可用可不用，但是BNO这里非常诡异，他必须要用，必须在中断的时间内把数据读走，否则就会出现数据出错或者其他的问题。而显然我们的驱动里读数据根本没考虑这个问题，根本不管是否可读，无脑读。所以有时候没数据需要重启，大概就是因为这个中断和读的时间错位了，导致一直读不到数据，报错了。



#### 额外回包

第一个广播以后，我请求了一次F9-产品信息的报告，这个数据长度也完整发完了，最后一次长度是0c，我每次读32字节（payload 28字节）

接着我就发了配置cmd，发了以后，他就回了我一个 

```
06 00 00 0C 01 0B 
```

我查了一下是说我在广播之前就发送了写，导致失败了，可是我明明是广播之后发送的。

![image-20220103162409630](https://s2.loli.net/2022/01/03/TXtHg8pdj7IuKv6.png)

然后在这个错误以后，继续读，还会发送BNO还在回信息给我，而且是F9的信息，非常奇怪。之后开始读数据，就一直返回00。



#### 包序配置错误

以为BNO是包序有问题，得多读一些，于是将整个配置信息再往后放，先读他个十七八遍，然后就发现，这个异常回包依然会有，而只要我写了配置信息，就必然会报错。



#### 参考官方驱动

BNO技术支持建议我参考官方驱动，我先看了一下流程，官方重启芯片以后需要等Reset ACK。而我这里明显毛都没有。

于是重新写重启流程，硬等Reset的返回命令。



等到Reset返回以后，再进行读和设置。这里还有一个很奇怪的现象，传感器以及重启了，但是依然会发送广播包，等广播发完了，才能回Reset的信息，就很奇怪。

而出问题的芯片直接在等待Reset这一步就出错了，根本没有Reset Completed 回传，一直等不到，那就Reset失败了，而这个问题只能原厂解决了，我没办法了。



## 解决

等原厂回复....
