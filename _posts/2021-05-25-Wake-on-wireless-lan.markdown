---
layout:     post
title:      "无线网络唤醒，从入门到放弃"
subtitle:   "wol,PCI Express WAKE"
date:       2021-05-25
update:     2021-05-25
author:     "elmagnifico"
header-img: "img/springboot.jpg"
catalog:    true
mathjax:    false
tags:
    - PC
---

## Foreword

最近需要在公司使用家里的电脑，出门忘记开机了，就导致无法远程，很麻烦，所以这次来探索一下如何远程唤醒。



## 唤醒的几种方式

### Wake on Lan

一般都是指通过有线网络唤醒，原理比较简单，实际上关机以后主板网口不断电，并且还运行着小型协议栈，它可以收包，如果收到了特定的包，就可以唤醒主板，启动。



要求，能唤醒要求，主板支持，网卡支持，驱动支持，操作系统支持，路由器支持，中间任何一人不支持都不行。



但是这种操作比较复杂，说一下要点：

1. BIOS中必须开启Wake on Lan的功能或者是 PCI Express/ PCI Wake，一般都在电源/网络/PCI选项中
2. 对应网卡驱动-属性-高级中开启有关唤醒的功能，关闭节能的功能
3. 网卡驱动-属性-电源管理-勾选允许计算机关闭此设备以节约电源，允许此设备唤醒计算机，只允许幻数包唤醒计算机（看情况）
4. 启用或关闭windows功能，勾选Simple TCPIP services（i.e.echo,daytime etc）,这个也是看情况开启
5. windwos电源管理中关闭快速启动（此项和具体的网卡主板有关系，有的需要有的可以无视）



![image-20210525165910354](https://i.loli.net/2021/05/25/3w4bGoMlWi1jnFc.png)

![image-20210525170435479](https://i.loli.net/2021/05/25/UFuKh4Q5f89BcGz.png)

![image-20210525170339078](https://i.loli.net/2021/05/25/LlQiGgP6sztOh2Z.png)



一般来说现在的主板基本都支持，只要设置正确了，大概率可以通过网络唤醒。只是很多时候可能主机没有连网线，也没办法连，那这就很尴尬了。



#### 排障

常见操作更新驱动，更新BIOS，或者是驱动退化等等就常规操作了。



**收不到wol包**

有可能是路由器中屏蔽了唤醒包，查看一下是否有相关防火墙设置，也有可能是windows自己的防火墙或者杀毒软件屏蔽了唤醒包。一般使用的是UDP 端口9



**IP与MAC地址不对应**

路由中将IP和MAC地址静态绑定，特别是穿透的时候容易出问题。



**唤醒包不同**

有的可能是第三方协议，不是幻数包，那么之前的只允许幻数包唤醒就不能勾选。



#### 查看设备是否允许唤醒

```
powercfg -devicequery wake_armed
```



#### 查看设备唤醒次数

```
powercfg -lastwake 
```

对应的结果类似下图

![image-20210525160423488](https://i.loli.net/2021/05/25/MgcJ6lavZ3r75q4.png)



## Wake on Wireless LAN

为了应对有线无法连接的问题，自然也就有了无线唤醒的方案，但是目前我基本没见人可以正常使用的。或多或少都有一些其他bug。

无线是工作在有线的基础上的，所以上文中的操作在无线这里都需要做一遍，并且还有一些额外的操作。



1. 对应网卡驱动-属性-高级中开启有关唤醒的功能，关闭节能的功能，WOWLAN和GTK，EAP等相关的都需要开启。

2. 注册表HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\NativeWifiP\Parameters中添加EnableWoWLAN，类型是DWORD，值为1



但是就算这些都做了，还是有大概率不能通过无线唤醒，具体原因嘛，我实在是找不到了。



#### 放弃过程

由于我是连不了网线，所以一直用一块PCIE的网卡，intel dual band wireless ac 8265，技嘉出品的，完全支持无线唤醒。



首先是怀疑幻数包没发出来，因为几个wakeonlan的软件比较老了，很可能早就不行了，然后实验了一下，发现

- Wake On Lan(远程唤醒电脑软件) v2.11官方版，不能用，发不出来包



发现路由器有唤醒功能，直接用路由器的，还是不行，再怀疑我路由上发的幻数包实际上没发出来，然后装了个wireshark，分析



可以看到，收到了，wireshark可以直接识别唤醒包，叫wol，实际上本质是个udp包，这说明没问题。

然后怀疑关机以后，pcie的无线网卡没电，所以关机以后仔细查看，发现主板有一个小灯亮着，不至于没电，但是pcie的网卡没有指示灯。



于是转而使用睡眠功能，这种情况下整个机箱都是亮的（ram的rgb亮着），看起来多数都带电状态，然后依然不行。

查看唤醒设备，pcie的网卡存在，查看唤醒次数，直接是0，说明这个包根本没收到，而没收到只有一种可能，就是这个无线网卡在关机或者休眠的时候断电了？

猜想是BIOS的问题，一看BIOS还是16年的，基本是出厂状态，于是乎又开始了升级BIOS，Prime z270-ar主板竟然从官网消失了，nmd，这当年顶配主板，说没就没了，只能人工客服提供下载链接。



#### 怀疑

Asus主板中没有单独的wake on lan选项，他实际叫做Power On By PCIE，而他们的这个PCIE仅仅是指主板上的网卡PCIE，对于其他PCIE插槽可能都断电了，这就导致我实际上收不到这个包，无法唤醒，那就要看看是否主板可以支持关机但是PCIE插槽上的设备不断电。



#### ErP Ready

这个是用来符合能效要求的选项，默认是关闭的，也就是不节能。

S1，CPU开启，其他外设基本都还勉强活着，对应睡眠状态

S2，CPU关闭，但是其他外设都是好的，省电状态

S3，挂起状态，只有内存活着，其他的设备都断电了，对应快速启动

S4，内存内容存入硬盘中保存，用来快速恢复，对应休眠状态

S5，全部断电



## 其他唤醒方式

比较常见的就是向日葵的开机插座，利用的方式比较简单，基本大多数主板都支持。主板中有一项上电检测的设置，相当于是说电源通电之后进行什么操作，可以是关机，可以是开机，也可以是断电前的状态。

![image-20210525165931104](https://i.loli.net/2021/05/25/JbiUNwpf46Kuv2h.png)

而基本上市面上多数唤醒都是利用这个功能，BIOS中可能叫做AC recovery或者中文叫断电恢复后电源状态。而要实现智能插座唤醒，就需要设置为断电恢复后-开机，这样每次关机是正常关机，但是本质上主板还没断电，而你通过操控智能插座断电-复电，从而让原本关机的状态切换为了开机。

向日葵的开机插座或者其他智能插座也都能实现相同的目的，而向日葵的开机棒，本质上就是个透传的工具而已，实际上还是发wol包来唤醒的，只是要求pc必须是有线连接在网络中的，很多高级或者刷机路由器都能代替他。



## Summary

基本上网上能看到的无线网络唤醒的例子或者视频都看过了，要么是帖子里语焉不详，我可以，我没问题，你有问题；要么就是视频模糊的要死，关键地方或者操作都马赛克，根本无法验证他是无线网络唤醒还是有线唤醒的。

而询问ASUS官方技术，也只能说WoLan试过，可以唤醒，但是WOWLan就不行了。

未完待续...



## Quote

> https://www.cnblogs.com/sjqlwy/p/up_wol.html
>
> http://blog.chinaunix.net/uid/1784963/year-201311-list-1.html
>
> https://linustechtips.com/topic/1139953-configuring-wake-on-wireless-lan-wowlan/
>
> https://community.intel.com/t5/Wireless/dual-band-wireless-ac-8265-will-not-stay-asleep-WOWLAN-issues/td-p/715554?profile.language=es



