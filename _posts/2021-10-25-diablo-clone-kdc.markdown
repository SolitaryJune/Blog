---
layout:     post
title:      "暗黑2重制版Diablo Clone Kill Event募集准备"
subtitle:   "ip,tcpview,kdc"
date:       2021-10-25
update:     2021-10-31
author:     "elmagnifico"
header-img: "img/Raspberrypi-head-bg.png"
catalog:    true
tags:
    - Game
---

## Forward

简单说 Diablo Clone 需要将 SOJ 卖给 NPC 才能有概率召唤到，而 SOJ 的价格一直比较高，100左右，要卖估计至少75个以上才能有比较大概率召唤到，所以必须集资来搞一个。当然很多人是为了卖毁灭护符赚钱（净利润500以上），而不是自己拥有。



最初的目的很简单，我想要一个，群友也有想要一个的，大家是处于自己拥有的目的来的，但是想要保险得凑够125个才有可能开车，那就至少125个人才行。发了很多征集贴，可惜人数还是太少了，与d2jsp他们比起来，人口基数太少了，他们短短2天就能募集够足够多的人开车，而且时间也能符合，国内想找合适时间的人很难，众口难调。



由于kdc需要所有人进入同一个ip的服务器内，而d2r又是随机给你ip的，就很难进到正确的服务器里，这里不但需要有正确的查看IP的姿势，还需要屏蔽IP的工具。



## TCPView

> https://docs.microsoft.com/zh-cn/sysinternals/downloads/tcpview

群文件里也有，我已经打包好了，可以直接打开，免安装

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/qzQS4NLrXOdMGni.png)

打开界面，首先修改过滤条件，过滤进程为d2r，并且过滤中不显示关闭的端口连接

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/oayYLcZksirvz6O.png)

### 确定你房间的IP

首先退回到选择人物界面，等一会，等界面里的连接稳定下来。然后创建房间，创建的时候就可以看到有一条绿色的

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/oGcPXNBZOl8ibrD.png)

如图，图里的**34.125.81.25** 就是你房间的IP了

一步到位，创建时间最新的这个，一般就是你的建房时间（偶尔有时候会额外冒出来一个24开头的ip，忽略即可）

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/WqhBlZzaGKjvIc1.png)



#### 排除选项

```
Port是1119的，肯定不是你的ip，这个是排队的端口
port是443的，有可能是你的ip，只要从这里面找就行了，这样选项就只剩下几个（一般是2个）
24.    开头的IP必然不是你的房间
34.117 开头的IP也必然不是你的房间
34.93  开头的IP也必然不是你的房间
137.221开头的IP也必然不是你的房间
117.52 开头的IP也必然不是你的房间
```



### 加速器问题

由于国内的特殊性，为了更好的体验，就得用加速器，这就导致有些加速器是通过本地代理、隧道之类的方式进行加速的，而TCPView是看不到这种方式下的IP地址的，一般都具有明显的标志性

```
比如ip全都是
127.0.0.1
10.xx.xx.xx
172.xx.xx.xx
192.xx.xx.xx
```

以上这几种都是加速器或者代理有可能使用的ip，看到这种情况，要么切换加速器的加速模式，要么就整个换加速器，否则无解。



**目前已知有部分加速器会导致TCPView闪退，如果遇到这种情况，建议直接换加速器吧**



## ip_block

为了方便的屏蔽IP，我还写了一个工具专门做这个事情，工具仅在我后台设置了ip屏蔽规则的情况下才能生效，需要实时联网。



#### 注意事项

**使用管理员权限启动ip_block.exe**

**务必保证你的windows 安全中心的防火墙是打开状态，否则过滤无法生效**

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/SuhWsCdlVIkArLa.png)

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/OTQXjkoeuEUfbsq.png)

打开ip_block.exe 就能看到下图，点击IP过滤，等待一会即可。然后重上游戏，检测你的IP，看IP的A和B段是否和目标一致，一致就开始建房，刷C和D段一致即可



新增了显示当前房间IP的功能，但是有可能出错，如果错了的话还请以TCPView为准

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/mZzKuyOeM9sVQPc.png)

运行时是这样的：就算找不到你的ip，也不影响屏蔽工作

![](http://img.elmagnifico.tech:9514/static/upload/elmagnifico/qxUvKs71RZhe3Y4.png)

**中间会有提示告诉你，当前屏蔽段是什么，随着上线的人变多，屏蔽的程度也会变。每次屏蔽改变会通知你，删除过滤，然后再点IP过滤，就能刷新屏蔽规则**

当不需要使用的时候，点击删除过滤即可。

任何时候上游戏有问题，点击删除过滤即可。



### IP说明

先科普一个常识

```
A.B.C.D
34.125.85.141
```

如上所示，每个点前面分别是A段、B段、C段、D段

过滤工具能做到的就是快速帮你过滤掉A和B段，建房的时候是随机在C和D段中随机一个。我的工具就是帮你屏蔽大量A和B段IP，让你只能进某个指定A.B段的。



#### 示例

假设我们kdc的ip是下面这个

```
34.125.85.141
```

你第一次重开游戏，查看ip是下面

```
34.199.147.112
```

这会直接退出游戏，再重开，这显然不对，再重开，得到了AB段相同，但是C段不同，这时依然需要大退游戏。

```
34.125.66.112
```

继续重开，这里A、B、C段就相同了，剩下就是别退出游戏了，重复建房，直到和34.125.85.141一模一样，然后等着就行了

```
34.125.85.174
```



有可能某些服C段是会来回跳的，这种服我们都会过滤出去，只在D段内随机，降低难度



## 视频教程


<iframe src="//player.bilibili.com/player.html?aid=548842122&bvid=BV1fq4y1G7xi&cid=432033318&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true" width="640px" height="480px">  </iframe>



## 暗黑2连接机制探索

当然也有很多人说ABC对了就行了，D无所谓，但是在群里小伙伴的支持下我们已经测试过了必须ABCD全对才能上车，否则根本没有任何售卖信息。

从国外帖子来看，光是进房这一步就要花掉一个半小时，完全是在随机撞房，直接就是一大波DDOS攻击。D2R这个设计还是非常蠢得。



### 通信机制

AB段的IP是在进游戏时，和服务器通讯决定的，因而如果AB段被屏蔽，进入游戏的时候会自动分配其他非屏蔽段的IP。

但是这个东西有一个问题，如果试用加速器并且是路由模式，经常会出现屏蔽失效的情况。

这个主要是因为，加速器的路由模式，其实是让游戏把包发给了加速器虚拟出来的一个路由中，虽然他看起来经过了防火墙，但是其实过了防火墙以后他就立马转给了加速去，然后加速器充当局部小路由，把刚才游戏的包发给了加速器节点，从而完成了加速。

```
游戏--->PC防火墙--->加速器局部路由，加速器封包转发--->PC防火墙--->加速器节点--->游戏服务器
```

这种情况下虽然PC防火墙可以生效，但是经常会出现漏包的情况，也就是说时而有效时而无效，这比较蛋疼。甚至有的时候通过TCPView是看不到这个过程中包的。唯一的解决办法就是加速器的局部路由中不添加需要屏蔽的路由，这部分让PC防火墙去屏蔽。然后得到的结果就是ok的。



还有一种客户端模式或者说隧道模式，这种模式由于所有包是在本地完成封包的，导致使用防火墙屏蔽，是不生效的。

```
游戏--->本地代理端口--加速器监听-->加速器封包转发--->PC防火墙--->加速器节点--->游戏服务器
```



我还测试了另外一种办法，进行屏蔽，直接在加速器的节点处屏蔽掉指定路由的包。但是这种方法无法生效，客户端不会自动切换AB段，反倒是直接超时了。猜测防火墙这种屏蔽，是在游戏内进行服务器探测的时候直接就返回了False，导致游戏内探测自动切换了。而一旦这个服务器的包发出来了（不是直接返回False），客户端就会认为这个地址可行，从而选择该地址了。有点像是防火墙相当于DNS，直接告诉客户端不可达，从而切换下一个服务器。而如果防火墙放行了，那么就认为可达，但是后续被屏蔽导致的超时情况，并不会进行处理。



更好的方法应该是能直接Hook到这个服务器判定的地方，直接送一个指定地址进行连接。这样是最方便的。



### 暗黑重置的IP段范围

不完全统计，实际上比想象的要大，想要做选区工具的话，就必须先拿到足够多的IP段表才能实现选区工具。

这个IP数量非常恐怖，假如一个ip里可以容纳100个玩家，那以这种计算，百万玩家在线都是可以的，只是目前这个排队太要命了，导致实际没有这么多。



##### 德国

```
34.89.176.176
34.98.35.234
34.99.176.176
34.103.176.176
34.107.35.234
34.141.35.234

35.198.68.110
35.207.68.110
35.234.68.110
35.235.35.234
35.246.176.176
```



##### 加拿大

```
34.95.2.133
34.130.35.234
34.144.35.234
34.152.8.30

35.203.43.127
35.215.35.234

104.132.176.176
```



##### 美国

```
34.66.58.224
34.67.35.234
34.68.35.234
34.69.35.234
34.70.212.205
34.71.204.249
34.72.193.66
34.73.35.234
34.74.35.234
34.75.35.234

34.82.185.13
34.83.20.166
34.85.141.83
34.86.195.102
34.94.113.34
34.96.35.234

34.100.68.110
34.102.12.249
34.103.68.110
34.104.35.234
34.105.65.105
34.106.179.79
34.108.35.234
34.109.35.234
34.110.35.234
34.111.35.234
34.112.35.234
34.113.35.234
34.114.35.234
34.115.35.234
34.116.71.183
34.117.35.234
34.118.35.234

34.121.183.74
34.122.27.115
34.123.244.95
34.125.1.238
34.126.35.234
34.127.23.205
34.128.35.234

34.132.158.223
34.133.35.234
34.134.35.234
34.135.238.3
34.136.223.67

34.138.91.43
34.139.242.52
34.143.35.234
34.144.68.110
34.145.97.210
34.148.35.234
34.150.184.8
34.152.68.110
34.153.35.234-34.191.35.234

35.184.5.202
35.185.194.216
35.186.35.234
35.188.193.106
35.190.135.205
35.191.35.234
35.192.35.234
35.193.35.234
35.194.35.234
35.196.35.234
35.197.35.7
35.199.172.10
35.202.35.234
35.203.142.199
35.206.35.234
35.207.35.234
35.208.35.234
35.209.35.234

35.211.35.234
35.212.35.234
35.221.35.234
35.222.35.234
35.223.35.234
35.224.190.107
35.225.118.33
35.226.94.176
35.227.182.136
35.229.55.230
35.230.39.236
35.231.48.135
35.232.35.234
35.233.183.170
35.235.107.228
35.236.0.81
35.237.35.234
35.238.13.63
35.239.72.218
35.243.35.234
35.245.240.42
35.247.43.16

104.133.35.234
104.134.35.234
104.135.35.234
104.154.219.42
104.155.160.137
104.196.57.254
104.197.217.43
104.198.109.106

146.148.39.171

158.115.201.220
158.115.204.238
158.115.206.177
```



##### 巴西

```
34.95.240.188
34.100.35.234
34.151.35.234

35.198.50.133
35.199.67.5
35.247.221.129

104.132.68.110
```



##### 新加坡

```
34.87.4.67
34.124.176.176
34.126.102.227

35.185.176.176
35.186.146.162
35.187.248.69
35.198.245.197
35.197.156.64

35.201.32.32
35.213.176.176
35.240.148.77
35.247.176.176
```



##### 澳大利亚

```
34.87.215.224
34.116.111.206
34.129.35.234
34.151.93.9

35.189.29.67
35.197.160.218
35.201.20.57
35.218.176.176
35.244.119.137

104.132.35.234

```



##### 荷兰

```
34.90.176.176
34.91.177.19
34.99.68.110
34.141.176.176
34.147.32.32

35.204.253.246
35.214.176.176

37.244.11.103
```



##### 韩国

```
34.64.173.162
35.216.35.234

104.132.32.32
```



##### 比利时

```
104.155.32.32
104.199.68.110

34.76.176.176
34.77.32.32
34.78.32.32
34.79.35.234
34.140.176.176

35.187.176.176
35.195.176.176
35.205.176.176
35.206.176.176
35.210.176.176
35.233.35.234
35.240.35.234
35.241.176.176

```



##### 瑞士

```
34.124.68.110
34.65.176.176

35.216.176.176
```



##### 芬兰

```
34.88.176.176
34.99.32.32


34.103.32.32
34.119.176.176

35.217.32.32
35.228.176.176

```



##### 英国

```
34.89.32.32
34.98.176.176

34.105.176.176
34.142.32.32
34.147.176.176

35.189.68.110
35.214.32.32
35.246.32.32
```



##### 日本

```
34.84.104.144
34.85.117.30
34.97.107.12
34.104.176.176
34.146.100.179

35.187.199.242
35.194.104.78
35.200.10.253
35.213.35.234
35.217.176.176
35.221.71.247
35.243.104.142

104.198.91.41

```



##### 台湾

```
34.80.116.235
34.81.105.103
34.137.176.176


35.185.135.103
35.187.148.202
35.189.173.76
35.194.168.38
35.201.175.3
35.221.200.131
35.229.135.83
35.234.25.242
35.236.171.43

104.155.208.7
104.199.143.56

130.211.241.233

```



##### 香港

```
34.92.1.100
34.96.137.246


34.150.110.206

35.215.176.176
35.220.133.103
35.241.107.32

```



##### 印度

```
34.93.12.42
34.100.176.176
34.131.176.176

35.200.248.41
35.244.54.148
```



##### 印度尼西亚

```
34.101.137.172

35.219.32.32
```



### 常用屏蔽

一般会把亚服所有的都屏蔽掉，主要是其中段太多了，互相跳很麻烦

```
35.1.1.1-35.255.255.255
34.1.1.1-34.116.255.255
34.118.1.1-34.255.255.255
```



## Summary

暗黑2会有这么个活动完全是因为当年SOJ复制，导致的SOJ溢出了，才会有这么个消耗SOJ的活动，但是现在实际上没有这么多SOJ的产出。想组织一次平民版的非常困难啊。



## Quote

>https://docs.google.com/spreadsheets/u/0/d/1pH08VGFoXII8gxNizv5Rtv-i1dkzv31Xl77iC6JAV_I/htmlview#
>
>https://www.youtube.com/watch?v=j8JNy1iD4YU&ab_channel=LuckyLuciano
>
>https://youtu.be/TbJOIMM5Ino
>
>https://forums.d2jsp.org/forum.php?f=240
>
>https://bbs.d.163.com/forum.php?mod=viewthread&tid=174025651&extra=
>
>https://bbs.d.163.com/forum.php?mod=viewthread&tid=174046865&extra=

